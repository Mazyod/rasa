language: python
dist: trusty
sudo: required
python:
  - '2.7'
  - '3.6'
cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/build/amn41/rasa_core/data
install:
  - sudo apt-get update
  - if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh
    -O miniconda.sh; else wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    -O miniconda.sh; fi
  - bash miniconda.sh -b -f -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  # Useful for debugging any issues with conda
  - conda info -a

  - conda create -q -n test-environment python=$TRAVIS_PYTHON_VERSION scipy=0.19.0 numpy=1.12.1 scikit-learn=0.18.1
  - source activate test-environment
  - pip install -r dev-requirements.txt
  - pip install spacy sklearn-crfsuite==0.3.5
  - pip install https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-1.2.0/en_core_web_sm-1.2.0.tar.gz
    --no-cache-dir > jnk
  - python -m spacy link en_core_web_sm en
  - pip install -e .
  - pip list   # for debugging
script:
  - travis_wait py.test tests --cov rasa_core --pep8 -v
jobs:
  include:
    - stage: docs
      install:
          - sudo apt-get update
          - pip install sphinx-autobuild sphinxcontrib-versioning nbsphinx
          - pip install -e -e git://github.com/RasaHQ/sphinx_rtd_theme.git#egg=sphinx_rtd_theme
      script:
        - eval "$(ssh-agent -s)"; touch docs/key; chmod 0600 docs/key
        - openssl aes-256-cbc -K $encrypted_050c822e99ef_key -iv $encrypted_050c822e99ef_iv
          -in docs/key.enc -out docs/key -d && ssh-add docs/key
        - git config --global user.email "builds@travis-ci.com"
        - git config --global user.name "Travis CI"
        - git remote set-url --push origin "git@github.com:$TRAVIS_REPO_SLUG"
        - export ${!TRAVIS*}  # Optional, for commit messages.
        - sphinx-versioning -e .gitignore -e .nojekyll -e README.rst push docs gh-pages .
